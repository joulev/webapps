name: Deploy

on:
  push:
    branches: [main]

jobs:
  check-changes:
    name: Check changes
    runs-on: ubuntu-latest
    outputs:
      anime: ${{ steps.changed.outputs.anime }}
      tategaki: ${{ steps.changed.outputs.tategaki }}
      website: ${{ steps.changed.outputs.website }}
      dependencies: ${{ steps.changed.outputs.dependencies }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changed
        with:
          filters: |
            anime:
              - 'apps/anime/**'
            tategaki:
              - 'apps/tategaki/**'
            website:
              - 'apps/website/**'
            dependencies:
              - 'packages/**'

  deploy-anime:
    name: Deploy anime.joulev.dev
    needs: check-changes
    if: needs.check-changes.outputs.anime == 'true' || needs.check-changes.outputs.dependencies == 'true'
    uses: ./.github/workflows/vercel.yml
    with:
      directory: ./apps/anime
    secrets:
      token: ${{ secrets.VERCEL_TOKEN }}
      org-id: ${{ secrets.VERCEL_ORG_ID }}
      project-id: ${{ secrets.VERCEL_PROJECT_ID_ANIME_JOULEV_DEV }}

  deploy-tategaki:
    name: Deploy tategaki.joulev.dev
    needs: check-changes
    if: needs.check-changes.outputs.tategaki == 'true'
    uses: ./.github/workflows/vercel.yml
    with:
      directory: ./apps/tategaki
    secrets:
      token: ${{ secrets.VERCEL_TOKEN }}
      org-id: ${{ secrets.VERCEL_ORG_ID }}
      project-id: ${{ secrets.VERCEL_PROJECT_ID_TATEGAKI_JOULEV_DEV }}

  deploy-website:
    name: Deploy joulev.dev
    needs: check-changes
    if: needs.check-changes.outputs.website == 'true'
    uses: ./.github/workflows/vercel.yml
    with:
      directory: ./apps/website
    secrets:
      token: ${{ secrets.VERCEL_TOKEN }}
      org-id: ${{ secrets.VERCEL_ORG_ID }}
      project-id: ${{ secrets.VERCEL_PROJECT_ID_JOULEV_DEV }}
